{% extends 'common/frame.html' %}

{% block title %}텍스트 입력 화면{% endblock %}

{% block content %}
<div class="row">
    <!-- 메인 콘텐츠 영역 -->
    <div class="col-md-9 col-lg-8">
        <div class="mt-4">
            <div class="section text-area-group">
                <h2 class="mb-4">텍스트 입력</h2>
                <form>
                    <!-- Selectbox 추가 -->
                    <div class="form-group mb-3">
                        <label for="category">카테고리 선택:</label>
                        <select class="form-control" id="category" name="category">
                            <option value="normal">심플LLM호출</option>
                            <option value="autocode">코드자동완성</option>
                            <option value="wordconversion">용어변환</option>
                            <option value="makecomment">주석설명 자동 생성</option>
                            <option value="makemapdatautil">테이블정보 사용하여 MapDataUtil 자동 생성</option>
                        </select>
                    </div>

                    <div class="form-group mb-3">
                        <label for="question">질문:</label>
                        <textarea class="form-control" id="question" name="question" rows="5"></textarea>
                    </div>


                    <div class="form-group mb-4">
                        <label for="reference-context">참고 컨텍스트:</label>
                        <textarea class="form-control" id="reference-context" name="reference-context" rows="5"></textarea>
                    </div>
                    <!-- Markdown Viewer로 변경 -->
                    <div class="form-group mb-3">
                        <label for="context">생성 결과 :</label>
                        <textarea class="form-control d-none" id="context" name="context" rows="5"></textarea>
                        <div id="markdownViewer" class="border p-3 bg-light"></div>
                    </div>
                    <button type="button" class="btn btn-success" id="callServiceButton">서비스 호출</button>
                    <!-- button type="submit" class="btn btn-primary">제출</button -->
                </form>
            </div>
        </div>
    </div>

    <!-- 오른쪽 사이드바 -->
    <div class="col-md-3 col-lg-4">
        <nav id="rightSidebar" class="bg-light sidebar">
            <div class="position-sticky pt-3 sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="collapse" href="#treeMenu1" role="button" aria-expanded="false" aria-controls="treeMenu1">
                            <span data-feather="folder"></span>
                            질문의 대분류1
                        </a>
                        <div class="collapse" id="treeMenu1">
                            <ul class="nav flex-column ms-3">
                                <li class="nav-item">
                                    <a class="nav-link" href="#">
                                        <span data-feather="file"></span>
                                        질문의 중분류 1-1
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="collapse" href="#subTreeMenu1" role="button" aria-expanded="false" aria-controls="subTreeMenu1">
                                        <span data-feather="folder"></span>
                                        질문의 중분류 1-2
                                    </a>
                                    <div class="collapse" id="subTreeMenu1">
                                        <ul class="nav flex-column ms-3">
                                            <li class="nav-item">
                                                <a class="nav-link" href="#">
                                                    <span data-feather="file"></span>
                                                    질문 소분류
                                                </a>
                                            </li>
                                            <!-- 추가 하위 메뉴 항목들 -->
                                        </ul>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <!-- 추가 루트 메뉴 항목들 -->
                </ul>
            </div>
        </nav>
    </div>
</div>

<!-- JavaScript로 Markdown Viewer 구현 -->
<script>

    document.addEventListener('DOMContentLoaded', function () {
        hljs.highlightAll();
        const contextTextarea = document.getElementById('context');
        const markdownViewer = document.getElementById('markdownViewer');

        // 실시간 Markdown 렌더링
        contextTextarea.addEventListener('input', function () {
            const markdownText = contextTextarea.value;
            markdownViewer.innerHTML = marked.marked(markdownText); // marked.js 사용
        });

        // 초기 렌더링
        contextTextarea.dispatchEvent(new Event('input'));

        // 서비스 호출 버튼 이벤트
        const callServiceButton = document.getElementById('callServiceButton');

        callServiceButton.addEventListener('click', function () {
            const category = document.getElementById('category').value;
            const question = document.getElementById('question').value;
            const context = document.getElementById('context').value;
            const referenceContext = document.getElementById('reference-context').value;

            const payload = {
                indexname : "",
                current_code : "",
                category: category,
                question: question,
                context: context,
                referenceContext: referenceContext
            };

            fetch_url = "";
            if ("normal" == category) {
                // fetch_url = "/codeassist/api/autocode";
            } else if ("autocode" == category) {
                fetch_url = "/codeassist/api/autocode";
            } else if ("wordconversion" == category) {
                fetch_url = "/termsconversion/api/conv";
            } else if ("makecomment" == category) {
                fetch_url = "/codeassist/api/makecomment";
            } else if ("makemapdatautil" == category) {
                fetch_url = "/codeassist/api/makemapdatautil";
            }

            
            showLoading();
            // API 호출
            fetch(fetch_url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                console.log(data);

                if (data) {

                    if ("autocode" == category) {
                        var response = data.response && data.response['response'] && data.response['response']['content'] ? data.response['response']['content'] : '';
                        
                        var result = "```java\n\n" + question + "\n// =========== 아래가 추가된 내용 ===========\n" + response;
                        //var result = question + response;

                        setMarkdownViewer(result); // 응답 데이터를 Markdown Viewer에 렌더링
                    } else if ("wordconversion" == category) {
                        var result = "```java\n\n";

                        var response = data.response;
                        if (Array.isArray(response) && response.length > 0) {
                            // 배열에 값이 있는 경우 처리 로직 추가
                            for (let i = 0; i < response.length; i++) {
                                result += response[i]
                            }
                        }
                        setMarkdownViewer(result); // 응답 데이터를 Markdown Viewer에 렌더링

                    } else if ("makecomment" == category) {
                        var response = data.response && data.response.response && data.response.response.content ? data.response.response.content : '';
                        var result = "```java\n\n" + response;
                        setMarkdownViewer(result); // 응답 데이터를 Markdown Viewer에 렌더링

                    } else if ("makemapdatautil" == category) {
                        var response = data.response && data.response.response && data.response.response.content ? data.response.response.content : '';
                        var result = response;
                        setMarkdownViewer(result); // 응답 데이터를 Markdown Viewer에 렌더링

                    }


                } else {
                    alert('API 호출에 실패했습니다: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                console.error('API 호출 중 오류 발생:', error);
                alert('API 호출 중 오류가 발생했습니다.');
            });
        });
    });

    /**
    * Markdown Viewer에 값을 설정하는 함수
    * @param {string} markdownText - 렌더링할 Markdown 텍스트
    */
    function setMarkdownViewer(markdownText) {
        const markdownViewer = document.getElementById('markdownViewer');
        const contextTextarea = document.getElementById('context');

        // Textarea에도 값을 동기화
        if (contextTextarea) {
            contextTextarea.value = markdownText;
        }

        // Markdown Viewer에 렌더링
        if (markdownViewer) {
            markdownViewer.innerHTML = marked.marked(markdownText); // marked.js 사용

            // 코드 하이라이트 적용
            markdownViewer.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
    }

    // 예제 호출
    setMarkdownViewer("# 제목1\n이것은 **Markdown** 예제입니다.");
</script>
{% endblock %}


<!-- 소스코드 주석생성 - 테스트 데이터
    public long calcIndvBnamt(Map pDoc) throws ElException, Exception {
        Map bizInput = null;
        long bnamt = 0;
        double dBnamt = 0;
        bizInput = pDoc;
        // 계약금액
        long cnttAmt = 0;
        // 계약상선급금액
        long prptAmt = 0;
        // 보증기간일수
        int diffDay = 0;
        // 계약체결일자
        String cnrcCncsDate = "";
        // 보증시작일자
        String gurtProdStda = "";
        // 보증종료일자
        String gurtProdEnda = "";
        // 대금지급주기월수
        String prcePaynCyclMncnt = "";
        cnttAmt = MapDataUtil.getLong(bizInput, "CNAMT");
        prptAmt = MapDataUtil.getLong(bizInput, "PRPT_AMT");
        cnrcCncsDate = MapDataUtil.getString(bizInput, "CNRC_CNCS_DATE");
        gurtProdStda = MapDataUtil.getString(bizInput, "GURT_PROD_STDA");
        gurtProdEnda = MapDataUtil.getString(bizInput, "GURT_PROD_ENDA");
        prcePaynCyclMncnt = MapDataUtil.getString(bizInput, "PRCE_PAYN_CYCL_MMCNT");
        // 보증기간을 구한다.
        if (!gurtProdStda.equals("") && !gurtProdEnda.equals("")) {
            diffDay = DateUtil.getDays(gurtProdStda, gurtProdEnda);
            diffDay = diffDay + 1;
        } else {
            // 넘어온데이타가 없으면 보증금액 계산불가로 0원으로 리턴해준다.
            bnamt = 0;
            return bnamt;
        }
        // 계약금액이 넘어오지 않으며 계산 불가이다.
        if (cnttAmt < 1) {
            bnamt = 0;
            return bnamt;
        }
        /*
	     * 보증금액 계산 
	     */
        // 건설기계대여업체인경우에는 다음의 식으로 계산이 되야 한다. => (하도급금액 - 계약상 선급금) / 공사기간(월) * 4
        if ("3".equals(MapDataUtil.getString(bizInput, "INDV_GURT_DSCD")) || "5".equals(MapDataUtil.getString(bizInput, "INDV_GURT_DSCD"))) {
            dBnamt = ((cnttAmt - prptAmt) * 30 / diffDay) * 4;
        } else {
            // 4월미만 공사인경우에는 보증금액 : 계약금액 - 선급금액
            if (diffDay <= 120) {
                AppLog.info("4개월미만 공사 계산  :: " + cnttAmt + " : " + prptAmt);
                dBnamt = cnttAmt - prptAmt;
            } else {
                // 아래의 계산식일경우 기성주기가 없으면 계산할 수 없다.
                if (prcePaynCyclMncnt == null || prcePaynCyclMncnt.equals("")) {
                    bnamt = 0;
                    return bnamt;
                }
                /*
				 * 4개월 이상공사 이면서, 기성주기가 2월 이내인 경우 
				 * 		=> (하도급금액 - 계약상 선급금) / 공사기간(월) * 4
				 * 4개월 이상공사 이면서, 기성주기가 2월 초과 
				 *      => (하도급금액 - 계약상 선급금) / 공사기간(월) * 기성주기(월) * 2
				 */
                if (Integer.parseInt(prcePaynCyclMncnt) <= 2) {
                    dBnamt = ((cnttAmt - prptAmt) * 30 / diffDay) * 4;
                } else {
                    dBnamt = ((cnttAmt - prptAmt) * 30 / diffDay) * Integer.parseInt(prcePaynCyclMncnt) * 2;
                }
            }
        }
        AppLog.info("보증수수료계산 :: ");
        AppLog.info("cnttAmt :: " + cnttAmt);
        AppLog.info("prptAmt :: " + prptAmt);
        AppLog.info("diffDay :: " + diffDay);
        AppLog.info("prcePaynCyclMncnt :: " + prcePaynCyclMncnt);
        AppLog.info("dBnamt :: " + dBnamt);
        // 10원단위 절사
        bnamt = Math.round(dBnamt);
        bnamt = (long) ((bnamt / 10) * 10);
        AppLog.info("\n bnamt :: " + bnamt);
        /**
         * 결과 반환
         */
        return bnamt;
    }


-->