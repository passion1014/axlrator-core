<script>
  $(document).ready(function () {
    //보내기 버튼 클릭
    $("#btnSend").on("click", function () {
      const question = $("#textMsg").val();
      if (!question) return false;
      $("#textMsg").val("");

      $("#btnSend").prop("disabled", true);
      $("#btnSend").removeClass("btn-send-animation");

      //   $.ajax({
      //     url: "/codeassist/api/makesql",
      //     type: "POST",
      //     contentType: "application/json",
      //     data: JSON.stringify({ question: question }),
      //     success: function (data) {
      const humanMessage = `<div class="chat-item type2">
                  <div class="text">${question}</div>
                  <div class="msg-icon-btns">
                      <button class="btn"><i class="bi bi-clipboard"></i></button>
                      <button class="btn"><i class="bi bi-hand-thumbs-up"></i></button>
                      <button class="btn"><i class="bi bi-hand-thumbs-down"></i></button>
                      <button class="btn"><i class="bi bi-volume-up"></i></button>
                      <button class="btn"><i class="bi bi-arrow-counterclockwise"></i></button>
                  </div>
              </div>`;

      const aiMessage = `
             <div class="markdown-wrap pt-3 border-top">
                  <div id="markdownViewer">
                      <p>
                      JavaScript의 <code>alert()</code> 함수는 웹 페이지에 팝업 창을 표시하여 메시지를 보여줍니다. 다음은 기본적인
                      <code>alert()</code> 함수 사용 예입니다.
                      </p>
                      <pre><code class="language-javascript hljs"><span class="hljs-title function_">alert</span>(<span class="hljs-string">"안녕하세요! 이것은 알림창입니다."</span>);</code></pre>
                      <p>
                      위 코드를 실행하면 웹 페이지 중앙에 "안녕하세요! 이것은 알림창입니다."라는 메시지가 담긴 팝업 창이 나타납니다.
                      사용자는 "확인" 버튼을 클릭하여 팝업 창을 닫습니다.
                      </p>
                      <p><strong>주의 사항:</strong></p>
                      <ul>
                      <li>
                          <code>alert()</code> 함수는 비동기적으로 실행됩니다. 즉, 알림창이 표시되고 사용자가 확인 버튼을 클릭할
                          때까지 다른 코드가 실행되지 않습니다.
                      </li>
                      <li>
                          <code>alert()</code> 함수는 단순한 메시지를 표시하는 데만 사용될 수 있습니다. 사용자 입력을 받거나 복잡한
                          작업을 수행하기 위해서는 다른 방법 (예: <code>prompt()</code>, <code>confirm()</code>) 을 사용해야 합니다.
                      </li>
                      </ul>
                      <p><strong>추가 예제:</strong></p>
                      <pre>
                          <code class="language-javascript hljs">
                              <span class="hljs-comment">// 변수에 메시지를 저장하고 alert 함수에 전달</span>
                              <span class="hljs-keyword">let</span> message = <span class="hljs-string">"이것은 변수에 저장된 메시지입니다."</span>;
                              <span class="hljs-title function_">alert</span>(message);
                              <span class="hljs-comment">// alert 함수를 다른 함수 내에서 사용</span>
                              <span class="hljs-keyword">function</span> <span class="hljs-title function_">showMessage</span>(<span class="hljs-params"></span>) {
                              <span class="hljs-title function_">alert</span>(<span class="hljs-string">"안녕하세요! 이것은 함수 내부에서 실행되는 알림창입니다."</span>);
                                  }
                              <span class="hljs-title function_">showMessage</span>();
                          </code>
                      </pre>
                  </div>
              </div>`;

      $("#chatScroll").html($("#chatScroll").html() + humanMessage + aiMessage);
      chatWrap.scrollDown();
      //이력 재 조회
      //
      // $.ajax({
      // 	url: "/codeassist/api/makesql",
      // 	type: "POST",
      // 	contentType: "application/json",
      // 	data: JSON.stringify({ question: question, sql_request: sql_request }),
      // 	success: function (data) {
      // 	},
      // });
      //     },
      //   });
    });
  }); //end of ready()

  const chatWrap = {
    el: document.getElementById("chatScroll"),
    getHeight() {
      return this.el.clientHeight;
    },
    getScrollTop() {
      return this.el.scrollTop;
    },
    getScrollHeight() {
      return this.el.scrollHeight;
    },
    scrollDown() {
      this.el.scrollTo(0, this.getScrollHeight());
    },
    eventScroll() {
      const btnDown = document.querySelector(".btn-scroll-down");
      this.getScrollTop() + this.getHeight() >= this.getScrollHeight()
        ? btnDown.classList.add("d-none")
        : btnDown.classList.remove("d-none");
    },
  };

  const clickBtn = function () {
    const text = document.getElementById("textMsg");
    const btn = document.getElementById("btnSend");
    if (!text.value) return false;
    btn.disabled = true;
    btn.classList.remove("btn-send-animation");
    text.value = "";
  };

  const inputText = function () {
    const btn = document.getElementById("btnSend");
    if (event.target.value.length > 0) {
      btn.disabled = false;
      btn.classList.add("btn-send-animation");
    } else {
      btn.disabled = true;
      btn.classList.remove("btn-send-animation");
    }
  };

  //코드복사 영역
  document.querySelectorAll("pre").forEach((pre) => {
    const divTop = document.createElement("div");
    divTop.classList.add("code-top");
    const copyBtn = document.createElement("button");
    copyBtn.classList.add("btn", "text-white", "bi", "bi-clipboard");
    copyBtn.innerText = "코드복사";
    divTop.appendChild(copyBtn);
    copyBtn.addEventListener("click", () => {
      const code = divTop.parentNode.querySelector("code").textContent;
      navigator.clipboard.writeText(code);
    });
    pre.insertBefore(divTop, pre.firstChild);
  });
</script>

<div class="contents-wrap">
  <div class="tit-wrap">
    <h2 class="tit01">Code Chat</h2>
  </div>
  <div class="row">
    <div class="col-8">
      <div class="chat-scroll" id="chatScroll" onscroll="chatWrap.eventScroll()"></div>

      <button class="btn btn-secondary btn-scroll-down d-none" onclick="chatWrap.scrollDown()">
        <i class="bi bi-chevron-double-down"></i>
      </button>

      <div class="chat-msg-wrap">
        <textarea placeholder="질문입력" class="form-control" id="textMsg" oninput="inputText()"></textarea>
        <div class="chat-file">
          <input type="file" class="form-control" />
          <span class="icon-file"><i class="bi bi-paperclip"></i></span>
        </div>
        <div class="chat-btns">
          <button id="btnSend" class="btn btn-primary btn-send-msg focus-ring" disabled>
            <i class="bi bi-arrow-up"></i>
          </button>
        </div>
      </div>
    </div>
    {% include 'view/common/chathistory.html' %}
  </div>
</div>
