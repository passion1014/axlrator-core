{% extends 'view/common/frame.html' %} {% block title %}용어 변환{% endblock %} {% block content %}

<script>
  //이력 조회
  const getChatHistory = function () {
    common.getRequest("/user/api/history", { type_code: "1" }, function (data) {
      let html = "";
      data.response.forEach((item, index) => {
        const data = item.data.replaceAll('"', "&quot;");
        html += `<li class="list-group-item pointer" data-id="${item.id}" data-data="${data}">${item.title}
                    <i class="fas fa-times delete-btn" data-id="${item.id}"></i>
                 </li> `;
      });
      $("#chatHistory").html(html);

      //이력 title버튼 클릭 이벤트
      $("#chatHistory li").click(function () {
        const data = $(this).attr("data-data").replaceAll("&quot;", "'");
        const list = JSON.parse(data);
        $("#iptQuestion").val(list[0].question);
        $("#iptAnswer").html(list[0].answer);
        $("#iptContext").val(list[0].context);
      });

      // X 버튼 클릭 시 항목 삭제 처리
      $(".delete-btn").click(function (event) {
        event.stopPropagation();
        const itemId = $(this).attr("data-id");

        common.getRequest("/user/api/delete", { id: itemId }, function (response) {
          getChatHistory();
        });
      });
    });
  };

  $(document).ready(function () {
    getChatHistory();

    //입력버튼 클릭이벤트 핸들러
    $("#btnInput").on("click", function () {
      const question = $("#iptQuestion").val();
      if (!question) return;

      $("#iptAnswer").text("");
      $("#iptQuestion").text("");

      const param = {
        indexname: "",
        current_code: "",
        category: "",
        question: question,
        context: "",
        sql_request: "",
      };

      common.postStreamRequest(
        "/codeassist/api/autocode",
        param,
        function (e) {
          const chunk = e.currentTarget.response;
          console.log(chunk.replaceAll("\n", "<br/>"));

          $("#iptAnswer").text(chunk); // 모든 데이터 표시
        },
        function (data) {
          console.log("success");
          //이력생성

          const param = {
            title: $("#iptQuestion").val(),
            type_code: "1",
            data: JSON.stringify([
              { question: $("#iptQuestion").val(), context: $("#iptContext").val(), answer: $("#iptAnswer").html() },
            ]),
          };
          common.postRequest("/user/api/history", param, function (data) {
            getChatHistory(); //이력 재조회
          });
        }
      );
    });
  });
</script>

<div class="contents-wrap">
  <div class="tit-wrap">
    <h2 class="tit01">프로그램 코드 생성</h2>
  </div>
  <div class="row">
    <div class="col-8">
      <div class="form-wrap">
        <div class="row">
          <div class="col-12">
            <label for="#" class="form-label">컨텍스트</label>
            <textarea class="form-control" rows="5" id="iptContext" disabled></textarea>
          </div>
          <div class="col-12 mt-3">
            <span class="form-label d-inline-block">답변결과</span>
            <pre id="iptAnswer"></pre>
          </div>
          <div class="col-12 mt-3">
            <label for="#" class="form-label">파일첨부</label>
            <input type="file" class="form-control" />
          </div>
          <div class="col-12 mt-3">
            <label for="#" class="form-label">질문 입력</label>
            <textarea class="form-control" rows="5" id="iptQuestion"></textarea>
            <div class="mt-2 text-end">
              <button type="button" class="btn btn-primary" id="btnInput">입력</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-4">
      <ul class="list-group" id="chatHistory"></ul>
    </div>
  </div>
</div>

{% endblock %}
